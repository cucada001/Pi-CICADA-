<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PiMatch Escrow</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: linear-gradient(135deg,#1a2a6c,#b21f1f,#fdbb2d); color:white; text-align:center; padding:20px;}
    .card {background:rgba(255,255,255,0.1);border-radius:15px;padding:20px;margin:20px auto;width:90%;max-width:500px;}
    button {background:#6a11cb;background:linear-gradient(315deg,#2575fc,#6a11cb);border:none;color:white;padding:10px 20px;margin:5px;border-radius:10px;cursor:pointer;}
    button:hover {opacity:0.9;}
  </style>
</head>
<body>
  <h1>ğŸš€ PiMatch Escrow (0.5%)</h1>
  <div class="card" id="auth">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Pi</button>
    <p id="userStatus">ØºÙŠØ± Ù…Ø³Ø¬Ù„</p>
  </div>

  <div class="card" id="payment" style="display:none;">
    <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙØ¹Ø©</h2>
    <input id="amount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ù€Ï€"><br><br>
    <input id="memo" type="text" placeholder="Ø§Ù„ÙˆØµÙ"><br><br>
    <button onclick="createPayment()">ğŸ’³ Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†</button>
    <pre id="log"></pre>
  </div>

  <div class="card" id="escrow" style="display:none;">
    <h2>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¶Ù…Ø§Ù† Escrow</h2>
    <input id="serviceAmount" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø®Ø¯Ù…Ø© Ø¨Ø§Ù„Ù€Ï€"><br><br>
    <button onclick="createEscrow()">ğŸ”’ Ø¥Ù†Ø´Ø§Ø¡ Ø¶Ù…Ø§Ù†</button>
    <button onclick="releaseEscrow()">âœ… Ø¥ÙØ±Ø§Ø¬</button>
    <p id="escrowStatus"></p>
  </div>

<script>
const API_BASE = "/api";

function log(msg){document.getElementById("log").innerText += msg+"\n";}

async function login(){
  try {
    const scopes = ['payments'];
    const user = await Pi.authenticate(scopes,onIncompletePaymentFound);
    document.getElementById("userStatus").innerText = "Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ "+user.username;
    document.getElementById("payment").style.display="block";
    document.getElementById("escrow").style.display="block";
  } catch(e){ log("Ø®Ø·Ø£ ØªØ³Ø¬ÙŠÙ„: "+e); }
}

function onIncompletePaymentFound(p){log("Ø¯ÙØ¹Ø© ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©: "+JSON.stringify(p));}

async function createPayment(){
  const amount=document.getElementById("amount").value;
  const memo=document.getElementById("memo").value;
  Pi.createPayment({amount,memo,metadata:{note:memo}},{
    onReadyForServerApproval: (paymentId)=>{log("Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø© "+paymentId); fetch(API_BASE+"/approve",{method:"POST",body:JSON.stringify({paymentId})});},
    onReadyForServerCompletion:(paymentId,txid)=>{log("Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥ÙƒÙ…Ø§Ù„ "+txid); fetch(API_BASE+"/complete",{method:"POST",body:JSON.stringify({paymentId,txid})});},
    onCancel:(p)=>log("ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡"),
    onError:(e)=>log("Ø®Ø·Ø£:"+e)
  });
}

function createEscrow(){
  const price=parseFloat(document.getElementById("serviceAmount").value);
  const fee=price*0.005;
  const net=price-fee;
  document.getElementById("escrowStatus").innerText=`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¶Ù…Ø§Ù†: Ø§Ù„Ø³Ø¹Ø± ${price}Ï€ | Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© ${fee.toFixed(3)}Ï€ | Ø§Ù„ØµØ§ÙÙŠ ${net.toFixed(3)}Ï€`;
  fetch(API_BASE+"/escrow/create",{method:"POST",body:JSON.stringify({price,fee,net})});
}

function releaseEscrow(){
  document.getElementById("escrowStatus").innerText="âœ… ØªÙ… Ø§Ù„Ø¥ÙØ±Ø§Ø¬ Ø¹Ù† Ø§Ù„Ø¶Ù…Ø§Ù†";
  fetch(API_BASE+"/escrow/release",{method:"POST"});
}
</script>
</body>
</html>
