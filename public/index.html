<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PiMatch Escrow</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0d1117;
      color: #f0f6fc;
      text-align: center;
      padding: 20px;
    }
    .card {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin: 15px auto;
      max-width: 400px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    button {
      background: linear-gradient(45deg,#6a11cb,#2575fc);
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      margin-top: 10px;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.9;
    }
    input {
      width: 90%;
      padding: 8px;
      margin: 5px 0;
      border-radius: 6px;
      border: 1px solid #444;
      background: #161b22;
      color: white;
    }
    pre {
      text-align: left;
      background: #161b22;
      padding: 10px;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>ğŸš€ PiMatch Escrow (0.5%)</h1>

  <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div class="card" id="auth">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Pi</button>
    <p id="userStatus">ØºÙŠØ± Ù…Ø³Ø¬Ù„</p>
  </div>

  <!-- Ø§Ù„Ø¯ÙØ¹ -->
  <div class="card" id="payment" style="display:none;">
    <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙØ¹Ø©</h2>
    <input id="amount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (Ï€)">
    <input id="memo" type="text" placeholder="Ø§Ù„ÙˆØµÙ">
    <button onclick="createPayment()">ğŸ’³ Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†</button>
    <pre id="log"></pre>
  </div>

  <!-- Ø§Ù„Ø¶Ù…Ø§Ù† -->
  <div class="card" id="escrow" style="display:none;">
    <h2>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¶Ù…Ø§Ù† Escrow</h2>
    <input id="serviceAmount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ø®Ø¯Ù…Ø© (Ï€)">
    <button onclick="createEscrow()">ğŸ”’ Ø¥Ù†Ø´Ø§Ø¡ Ø¶Ù…Ø§Ù†</button>
    <button onclick="releaseEscrow()">âœ… Ø¥ÙØ±Ø§Ø¬</button>
    <p id="escrowStatus"></p>
  </div>

<script>
const API_BASE = "/api";

function log(msg){
  document.getElementById("log").innerText += msg + "\n";
}

async function login(){
  try {
    const scopes = ['payments'];
    const user = await Pi.authenticate(scopes, onIncompletePaymentFound);
    document.getElementById("userStatus").innerText = "Ù…Ø±Ø­Ø¨Ø§Ù‹ " + user.username;
    document.getElementById("payment").style.display = "block";
    document.getElementById("escrow").style.display = "block";
  } catch(e){ 
    log("Ø®Ø·Ø£ ØªØ³Ø¬ÙŠÙ„: " + e); 
  }
}

function onIncompletePaymentFound(payment){
  log("Ø¯ÙØ¹Ø© ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©: " + JSON.stringify(payment));
}

async function createPayment(){
  const amount = document.getElementById("amount").value;
  const memo = document.getElementById("memo").value;
  Pi.createPayment({ amount, memo, metadata: { note: memo } }, {
    onReadyForServerApproval: (paymentId)=>{ log("Ø¬Ø§Ù‡Ø² Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±: " + paymentId); },
    onReadyForServerCompletion: (paymentId, txid)=>{ log("ØªÙ… Ø§Ù„Ø¯ÙØ¹: " + txid); },
    onCancel: (p)=>log("ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡"),
    onError: (e)=>log("Ø®Ø·Ø£: " + e)
  });
}

function createEscrow(){
  const price = parseFloat(document.getElementById("serviceAmount").value);
  const fee = price * 0.005;
  const net = price - fee;
  document.getElementById("escrowStatus").innerText = `ğŸ”’ Ø¶Ù…Ø§Ù† ${price}Ï€ (ØµØ§ÙÙŠ Ù„Ù„Ù…Ø³ØªÙ„Ù…: ${net}Ï€ Ø¨Ø¹Ø¯ Ø®ØµÙ… ${fee}Ï€)`;
  fetch(API_BASE+"/escrow/create",{method:"POST",body:JSON.stringify({price})});
}

function releaseEscrow(){
  document.getElementById("escrowStatus").innerText = "âœ… ØªÙ… Ø§Ù„Ø¥ÙØ±Ø§Ø¬ Ø¹Ù† Ø§Ù„Ø¶Ù…Ø§Ù†";
  fetch(API_BASE+"/escrow/release",{method:"POST"});
}
</script>
</body>
</html>
